trigger:
  branches:
    include:
      - main

# Link to the variable group containing secrets
variables:
- group: llm-deploy-vars

# Static pipeline variables
- name: azureSubscription
  value: 'Pay-As-You-Go'
- name: resourceGroup
  value: 'mlops'
- name: workspaceName
  value: 'llm_mlops'
- name: endpointName
  value: 'stability-endpoint'

stages:
- stage: Deploy
  jobs:
  - job: DeployModel
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - checkout: self

    - task: UsePythonVersion@0
      inputs:
        versionSpec: '3.9'

    - script: |
        python -m pip install --upgrade pip
        pip install azure-ai-ml azure-identity
      displayName: 'Install Azure ML SDK'

    - script: |
        az login --service-principal -u $(servicePrincipalId) -p $(servicePrincipalKey) --tenant $(tenantId)
        az ml online-endpoint create --file endpoint.yml \
          --workspace-name $(workspaceName) --resource-group $(resourceGroup)
      displayName: 'Deploy Model to Azure ML'

    - script: |
        az ml online-endpoint invoke \
          --name $(endpointName) \
          --request-file request.json \
          --workspace-name $(workspaceName) \
          --resource-group $(resourceGroup)
      displayName: 'Test LLM Endpoint'
